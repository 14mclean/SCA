<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Log In - SCA</title>
        <link href='https://fonts.googleapis.com/css?family=Raleway' rel='stylesheet'>
        <link rel="stylesheet" href="css/login.css">
    </head>

    <body>
        <header>
            <a class="back_arrow" href="javascript:history.back()">ðŸ ”</a>
            <h1><a href="/">School Citizen Assemblies</a></h1>
        </header>

        <main>
            <div class="form_container">
                <h1>Log In</h1>

                <form onsubmit="check_credentials(this); return false;" action="phpScripts/login.php" method="POST">
                    <input id="email_input" name="email" type="email" placeholder="E-mail" required>

                    <input id="password_input" name="password" type="password" placeholder="Password" required>
                    <img src="assets/noEye.png">

                    <p id="bad-login">The email and/or password is not valid, please try again.</p>
                    <p id="unverified-email">The email address associated with this account has not been validated</p>
                    
                    <input id="last" type="text" style="display: none;">

                    <a class="register-button">Register Here</a>

                    <button>Login</button>
                </form>
            </div>
        </main>

        <div class="decision-blur">
            <a id="teacher-decision" href="register.php?level=Teacher">
                <h1>User/Teacher</h1>
                <p>If you want to search through the directory for resources provided by experts</p>
            </a>

            <a id="expert-decision" href="register.php?level=Expert">
                <h1>Expert</h1>
                <p>If you want to contribute your knowledge and resources to the directory and the users searching it.</p>
            </a>
        </div>
    </body>

    <script>
        document.querySelector("img").addEventListener("click", swap_visibility);
        function swap_visibility(event) {
            const password_input = document.querySelector('#password_input');

            if(password_input.type == "password") {
                password_input.type = "text";
                event.target.src = "assets/openEye.png";
            } else {
                password_input.type = "password";
                event.target.src = "assets/noEye.png";
            }
        }

        function check_credentials(form) {
            const password = document.querySelector('#password_input').value;
            const email = document.querySelector('#email_input').value;

            if(document.querySelector("input#last").value != "") {
                return false;
            }

            fetch("/phpScripts/credentials_check.php", {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({"email":email,"password":password})
            })
            .then(response => {
                switch(response.status) {
                    case 200:
                        form.submit();
                        break;
                    case 401:
                        return response.text();
                        break;
                    default:
                        throw new Error('Server error ' + response.status);
                }
            })
            .then(content => {
                if(content == "Email not verified") {
                    document.querySelector('#unverified-email').style.display = "block";
                    document.querySelector('#bad-login').style.display = "none";
                } else if(content == "Invalid") {
                    document.querySelector('#bad-login').style.display = "block";
                    document.querySelector('#unverified-email').style.display = "none";
                }
            });
        }

        document.querySelector(".decision-blur").addEventListener("click", decision_visibility);
        document.querySelector(".register-button").addEventListener("click", decision_visibility);
        function decision_visibility(event) {
            const decision_blur = document.querySelector(".decision-blur");
            
            if(decision_blur.style.display == "block") {
                decision_blur.style.display = "none";
                
            } else {
                decision_blur.style.display = "block";
            }
        }
    </script>
</html>