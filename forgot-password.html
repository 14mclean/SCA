<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Forgot Password - SCA</title>
        <link href='https://fonts.googleapis.com/css?family=Raleway' rel='stylesheet'>
        <link rel="stylesheet" href="css/forgot-password.css">
    </head>

    <body>
        <header>
            <a class="back_arrow" href="javascript:history.back()">ðŸ ”</a>
            <h1><a href="/">School Citizen Assemblies</a></h1>
        </header>

        <main>
            <div class="form_container">
                <h1>Password Reset</h1>

                <p id="descriptor">Enter the email address that you used to register. We will send you an email with a link to reset your password.</p>

                <form>
                    <input id="email_input" name="email" type="email" placeholder="E-mail" required>
                    <button type="submit">Send</button>
                </form>
            </div>
        </main>
    </body>

    <script>
        const form = document.querySelector("form");
        const email_input = document.querySelector("input#email_input");

        form.addEventListener("submit", (event) => {
            event.preventDefault();

            fetch("/api/users?filter=" + btoa(JSON.stringify({"email":{"operator":"", "value": [email_input.value]}})))
            .then(response => {
                if(response.ok) {
                    return response.json();
                } else {
                    throw new Error('Server error ' + response.status);
                }
            })
            .then(json => {
                if(json.length > 0) {
                    fetch("phpScripts/send_password_reset_email.php", {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({"email": email_input.value})
                    });

                    window.location.href="index.php";
                } else {
                    email_input.setCustomValidity("No matching email address");
                    email_input.reportValidity();
                }
            });
        });
    </script>
</html>